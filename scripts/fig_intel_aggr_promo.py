import matplotlib.pyplot as plt
import matplotlib.ticker
import numpy as np
import os
import subprocess

output_dir = os.path.expanduser("~") + "/Sync/research/devel/2019_ispass/tmp/taco_19/figures"
fig_name = "fig_intel_clang_aggr_promo"
#fig_name = "fig_intel_mysql_aggr_promo"
filename = "%s/%s.pdf" % (output_dir, fig_name)

# clang
cycles = {
'Total ITLB stall cycles': {'data': [126099503022.00, 112035700441.00, 93300762858.00, 66286842850.00, 58047430119.00, 48096816399.00, 49417101025.00, 48348482177.00, 43529304463.00, 45362863716.00, 48312111913.00, 41023061524.00, 37817947987.00, 37822859664.00, 35343825115.00, 38344896134.00, 43624944135.00, 43892164973.00, 43502197795.00, 48726274822.00, 47363713263.00, 47615861571.00, 49537323765.00, 48741647821.00, 49500515737.00, 49119122079.00, 49240226526.00, 49840634201.00, 49835881462.00, 49910360235.00, 49621836360.00, 49621836360.00, 49128966961.00], 'mark': 's', 'markerfacecolor': 'blue', 'markeredgecolor': 'blue', 'markersize': '5'},

'Pipeline-induced ITLB stall cycles': {'data': [71922963407.89, 65029028936.00, 59212456699.00, 38577779856.00, 36931604203.00, 28164503626.00, 29463566732.00, 29626980435.00, 26746643509.31, 28255564327.00, 36199574554.00, 32403094268.00, 29706779954.00, 30358606678.49, 27233676450.00, 29217813432.00, 35277481564.00, 35532779825.00, 34044837263.00, 39673477634.00, 38313793631.00, 38011916213.00, 40291804452.00, 39499540092.00, 40254769194.00, 39890274695.00, 40005389191.00, 40588760777.00, 40586802227.00, 40674394824.00, 40383047369.00, 40373797933.00, 39880408434.09], 'mark': 'D', 'markerfacecolor': 'green', 'markeredgecolor': 'green', 'markersize': '5'},

'Inst STLB hit cycles': {'data': [28588434838.11, 23827115123.00, 15454869332.00, 14214383708.00, 10921924566.00, 10916902472.00, 10923187331.00, 9993941244.00, 9990190137.69, 10356227217.00, 6244213626.00, 4241190499.00, 4258851716.00, 3687018670.51, 4674934782.00, 6180963705.00, 6180139868.00, 6187407100.00, 7292143537.00, 7277759755.00, 7276659453.00, 7833071141.00, 7805963053.00, 7805895727.00, 7812635642.00, 7794074498.00, 7799536178.00, 7813263836.00, 7812965363.00, 7803573764.00, 7800750657.00, 7810000093.00, 7814101267.91], 'mark': 'v', 'markerfacecolor': 'red', 'markeredgecolor': 'red', 'markersize': '5'},

'Inst page walk cycles': {'data': [25588104776.00, 23179556382.00, 18633436827.00, 13494679286.00, 10193901350.00, 9015410301.00, 9030346962.00, 8727560498.00, 6792470816.00, 6751072172.00, 5868323733.00, 4378776757.00, 3852316317.00, 3777234315.00, 3435213883.00, 2946118997.00, 2167322703.00, 2171978048.00, 2165216995.00, 1775037433.00, 1773260179.00, 1770874217.00, 1439556260.00, 1436212002.00, 1433110901.00, 1434772886.00, 1435301157.00, 1438609588.00, 1436113872.00, 1432391647.00, 1438038334.00, 1438038334.00, 1434457259.00], 'mark': 'o', 'markerfacecolor': 'orange', 'markeredgecolor': 'orange', 'markersize': '5'},

'Data page walk cycles': {'data': [20735874623.00, 20325025214.00, 19535953543.00, 18023904335.00, 16878317251.00, 16719680172.00, 16422567269.00, 14878710291.00, 14122619721.00, 14021425529.00, 13675939654.00, 13473788284.00, 13347820339.00, 11931401850.00, 11716319600.00, 11834056443.00, 10819766698.00, 10843281507.00, 10848037174.00, 10694172328.00, 10253150622.00, 10209014291.00, 10092041933.00, 10012545901.00, 9852941060.00, 9862990441.00, 9765818568.00, 9798048430.00, 9776417364.00, 9812173306.00, 9909660001.00, 9909660001.00, 9750530512.00], 'mark': 'o', 'markerfacecolor': 'None', 'markeredgecolor': 'black', 'markersize': '3'},
}

superpage_cdf = {
'x': [33, 32, 32, 31, 31, 30, 30, 29, 29, 28, 28, 27, 26, 26, 25, 25, 24, 23, 23, 22, 22, 21, 21, 20, 20, 19, 19, 18, 18, 17, 17, 16, 15, 14, 14, 13, 13, 12, 11, 11, 10, 9, 9, 8, 7, 7, 6, 5, 4, 3, 2, 1],
'y': [0, 0, 1, 1, 3, 3, 5, 5, 7, 7, 8, 8, 8, 10, 10, 11, 11, 11, 12, 12, 14, 14, 15, 15, 16, 16, 17, 17, 18, 18, 21, 21, 21, 21, 22, 22, 24, 24, 24, 25, 25, 25, 26, 26, 26, 27, 27, 27, 27, 27, 27, 27]
}

# mysql
#cycles = {
#'Total ITLB stall cycles': {'data': [932954355740.75, 579277955417.60, 428836211875.00, 428840416320.00, 426776320348.00, 397949377857.60, 400740387392.50, 394943915469.50, 396890673720.00, 353132369565.00, 346690766195.80, 350381580995.25, 347136041210.80, 353203072838.75, 352963191921.20, 337052697485.20, 339909986775.50, 336291574605.00, 337343749062.40, 336288375524.25, 340254249442.00, 335849545868.00, 337926249892.80, 343547715376.20, 340754921161.00, 336761047586.75, 336819322907.60, 336073579262.60, 339425116476.40, 336708856413.25, 335618411334.40, 336163633873.80, 335891022604.10], 'mark': 's', 'markerfacecolor': 'blue', 'markeredgecolor': 'blue', 'markersize': '5'},
#
#'Pipeline-induced ITLB stall cycles': {'data': [525429930015.60, 309656904653.00, 260647523115.80, 260179741442.25, 259065803608.60, 253691011961.20, 255858685045.10, 253249734374.30, 255035381027.20, 229417673060.85, 225383202371.15, 225899303515.50, 225384325593.20, 230336073348.15, 229125400800.37, 223162293661.40, 229540171599.70, 223859476244.60, 225064533386.40, 230359228873.55, 234811580675.60, 229436295645.75, 231076734718.05, 236427946858.95, 235635375135.80, 233081258445.42, 233101834117.45, 233156286289.25, 234850597816.35, 233294237964.20, 233294237964.20, 272276573634.20, 272276573634.20], 'mark': 'D', 'markerfacecolor': 'green', 'markeredgecolor': 'green', 'markersize': '5'},
#
#'Inst STLB hit cycles': {'data': [80019384481.75, 78823434207.00, 30772299111.40, 30748625194.00, 30616817490.00, 19646706346.40, 19665928017.40, 19975832738.40, 19673617567.80, 14096602689.40, 13825708510.25, 14041963027.75, 14017446030.00, 14136025079.40, 13895304523.33, 12750965106.60, 12748620133.20, 12996053630.00, 12807684505.00, 13853588655.20, 13502057585.80, 13822778767.00, 13726527220.00, 14910371005.25, 15097722371.20, 15643672996.00, 15463979357.40, 15598071620.60, 15527682753.80, 15546995690.80, 15546995690.80, 21865944864.40, 21865944864.40], 'mark': 'v', 'markerfacecolor': 'red', 'markeredgecolor': 'red', 'markersize': '5'},
#
#'Inst page walk cycles': {'data': [327505041243.40, 190797616557.60, 137416389647.80, 137912049683.75, 137093699249.40, 124611659550.00, 125215774330.00, 121718348356.80, 122181675125.00, 109618093814.75, 107481855314.40, 110440314452.00, 107734269587.60, 108730974411.20, 109942486597.50, 101139438717.20, 97621195042.60, 99436044730.40, 99471531171.00, 92075557995.50, 91940611180.60, 92590471455.25, 93122987954.75, 92209397512.00, 90021823654.00, 88036116145.33, 88253509432.75, 87319221352.75, 89046835906.25, 87867622758.25, 87873985882.40, 83628654508.25, 83173745227.80], 'mark': 'o', 'markerfacecolor': 'orange', 'markeredgecolor': 'orange', 'markersize': '5'},
#
#'Data page walk cycles': {'data': [421576656363.80, 351405425723.20, 316510411053.80, 308948870907.80, 313847837799.00, 298529984693.80, 301113758258.00, 280689403372.80, 275486337323.80, 269048648537.75, 270377777289.00, 266874992020.00, 278806341801.60, 268690115192.40, 269051807389.00, 267252002002.25, 262447800554.40, 260853988238.50, 261850858433.75, 264424434581.80, 261199451437.75, 262958362610.00, 259417947142.20, 264945309133.25, 258225145585.40, 258823546252.00, 254568848300.60, 259111129203.60, 255622515813.25, 258320415562.50, 260522618191.00, 256857516885.20, 258661734014.00], 'mark': 'o', 'markerfacecolor': 'None', 'markeredgecolor': 'black', 'markersize': '3'},
#}
#
#superpage_cdf = {
#'x': [33, 32, 32, 31, 31, 30, 29, 28, 28, 27, 27, 26, 25, 25, 24, 24, 23, 22, 21, 20, 19, 18, 17, 16, 15, 15, 14, 13, 13, 12, 11, 10, 10, 9, 9, 8, 7, 6, 5, 5, 4, 3, 2, 1, 1],
#'y': [0, 0, 5, 5, 6, 6, 6, 6, 8, 8, 9, 9, 9, 10, 10, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 12, 12, 12, 13, 13, 13, 13, 14, 14, 15, 15, 15, 15, 15, 16, 16, 16, 16, 16, 17]
#}

dots_x = []
dots_y = []
for i in range(len(superpage_cdf['x'])):
    dot_x = superpage_cdf['x'][i]
    if i < len(superpage_cdf['x']) - 1:
        next_dot_x = superpage_cdf['x'][i+1]
    else:
        next_dot_x = 100
    dot_y = superpage_cdf['y'][i]
    if dot_x != next_dot_x:
        dots_x.append(dot_x)
        dots_y.append(dot_y)
superpage_dots = {'x': dots_x, 'y': dots_y}
#print(superpage_dots)


"""Plotting"""

plt.xlabel('Promotion threshold: # of physically resident 64KB clusters required in a superpage-sized region')
plt.ylabel('Cycles (billion)')

plt.xticks(np.arange(1, 34, 4), np.arange(32, -1, -4))
plt.yticks(np.arange(0, 140*10**9 + 1, 20*10**9)) # clang
#plt.yticks(np.arange(0, 10**12 + 1, 10**11)) # mysql
ax1 = plt.gca()
ax1.set_xlim(xmin=-0.5)
ax1.set_ylim(ymin=0)
ax1.yaxis.set_major_formatter(matplotlib.ticker.FuncFormatter(lambda y, pos: "%d" % (y / 10**9)))

lines = []
for name, series in cycles.items():
    line = plt.plot(series['data'], label=name, marker=series['mark'], markerfacecolor=series['markerfacecolor'], markeredgecolor=series['markeredgecolor'], markersize=series['markersize'], linestyle="None")
    lines.append(line)

plt.legend(prop={'size': 'medium'}, bbox_to_anchor=(.05, 1), loc='upper left')

ax2 = plt.gca().twinx()
ax2.set_ylabel('# Superpages')
ax2.set_yticks(np.arange(0, 35 + 1, 5)) # clang
#ax2.set_yticks(np.arange(0, 20 + 1, 2)) # mysql
#ax2.set_yticklabels(np.arange(0, 20 + 1, 2))
ax2.set_ylim(ymin=0)
superpage_color = 'purple'
ax2.plot([33 - x for x in superpage_cdf['x']], superpage_cdf['y'], color=superpage_color)
ax2.plot([33 - x for x in superpage_dots['x']], superpage_dots['y'], label='# superpages', marker='o', markerfacecolor=superpage_color, markeredgecolor=superpage_color, markersize='3', linestyle="None")

plt.legend(prop={'size': 'medium'})

plt.savefig(filename, bbox_inches='tight')
#plt.show()
plt.close()
